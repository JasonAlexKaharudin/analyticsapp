<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" 
    rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.min.js" integrity="sha384-Atwg2Pkwv9vp0ygtn1JAojH0nYbwNJLPhwyoVbhoPwBhjQPR5VtM2+xf0Uwh9KtT" crossorigin="anonymous"></script>
    <script src="https://cdn.zingchart.com/zingchart.min.js"></script>
    <title>Home Page</title>
    <style>
        main{
            margin: 5vh;
        }
        nav{
            padding: 3vw;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-light navbar-expand-lg" style="background-color: #e3f2fd;">
        <div class="container-fluid">
          <a class="navbar-brand" href="/home">Jason and Bruce</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="navbar-collapse collapse ms-auto" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li><a class="nav-link "  href="/home">Home</a></li>
                <li><a class="nav-link active" aria-current="page" href="/reports">Reports</a></li>
                <li><a class="btn btn-primary" href="/logout">Logout</a></li>
            </ul>  
          <div>
        </div>
      </nav>
    <header style="margin: 5vh;">
      <h1>Detailed Report on Load Times</h1>
      <hr>
    </header>

    
    <main style="margin-left: 6vw; margin-right: 7vw;">
        <div style="margin-left: 8vw; margin-right: 7vh; margin-bottom: 5vh;">
          <h2>How many users are experiencing load times of more than 1000ms?</h2>
        </div>
        
        <div style="text-align: left; margin-left: 6vw; margin-right: 7vw;">
          <p>With the help of analytics,
            we can measure our website's performance across all users who visit our site.
           Performance, specifically load time, is one of the key metrics that defines user experience. The RAIL
           model can help us create a framework in which performance is measured and thus improved. the RAIL model offers
           a powerful tool to improve user experience. RAIL <i>(Responsive, Animation, Idle, Load)</i>,
           is a user-centric model which means the user is the source and main perspective of 
           the measurements.
         </p>

         <p style="line-height: 1.05cm;">
          As a general rule, anything with an overall load time of more than 1000 miliseconds (1 second) is considered bad
          user experience. As the professor has put it, there should not be any WSOD (White Screen Of Death). In this report we will be
          focusing on the Load part of RAIL to give some insights into the site's performance for load times, 
          what it means as a developer hoping to improve user experience and ultimately answer the question: <i> <b> How many users are experiencing load time of more than 1000ms?</i></b>
         </p>
        </div>

        <section class="mainChart" style="margin-left: 15vh;">
          <div id="loadTime" class="chart--container"></div>
        </section>
    
        <section style="margin-left: 6vw; margin-right: 7vw;">
          <h3>Findings from the main chart</h3>

          <p>
            It can be seen from the bar chart that out of all of the visitors who have visited our site, none of the users
            experience a load time of more than 1000 miliseconds (marked with a red line on the Y-axis). While good, a few users 
            do come dangerously close. 
          </p>

          <p>  
            When it comes to load times, it is important to note that there are a few fallacies that needs to be addressed. The network is never
            reliable, latency is not always zero and bandwidth is never infinite.
            Latency and bandwidth are two things that are highly variable depending on the user's network and capacity. This variability makes investing
            the users who are close to the critical point slightly more difficult to address. While it would be tedious and unreasonable to
            cover all bases (in some cases impossible), it is good that there are no users, as of now, who are above the critical point.
          </p>
        </section>

        <section class="piech" style="margin-left: 6vw; margin-right: 7vw; margin-top:5vh;">
          <h3>Effective Connection Type</h3>

          <p>
            <b>Effective Connection Type</b> (ECT) is the measured performance that converted into a cellular connection type. Thus, it does not matter if
            the connection was actually through a WiFi which makes comparisons a little bit easier. ECT is a specified time between the browser sending a request for the page and the type of connection with regards 
            to that. You can find more information on what constitutes a 2g,3g, and 4g connection type in this link <a href="https://developer.mozilla.org/en-US/docs/Glossary/Effective_connection_type">ECT MDN</a>. 
            We can use this data to find out whether or not it was due to the individual network that users experience a close to critical time of load times.
          </p>
        
          <div style="margin-bottom: 5vh;" id="piechart"></div>

          <p>
            From this pie chart, we can see that we have an overwhelming amount of users who has connection type of 4g.
            According to MDN, 4g network connections is suited for heavy use of network activity such as
            streaming HD video and real-time video. This means that our users have a generally very good connection type and speeds.
            This suggests that the network from the user side is not the cause of having load times near or above the critical point. However, 
            it is important to that it is unwise to assume that because most users have 4g connection type, means that there is no issues with 
            network activity.
          </p>
        </section>

        <section id="grid" style="margin-left: 6vw; margin-right: 7vw; margin-top:5vh;">
            <h3>Performance Timing Object</h3>
            <p>
                Adding to load times, the JavaScript performance.timing object offers various metrics that can help us understand
                more in depth the details of the timings and respective events such as "onload" and "unload". Using this, we can specify the areas
                that needs more attention to.
            </p>

            <table class="table table-striped table-hover" id="userTable">
                <thead>
                    <tr>
                        <th>domContentLoadedEventStart (ms)</th>
                        <th>domContentLoadedEventEnd (ms)</th>
                        <th>DOM load (ms)</th>
                        <th>requestStart (ms)</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">                
                    <!-- EDIT USER MODAL -->
                    
                </tbody>
            </table>

            <p>
              From this grid, we have three main columns: domContentLoadedEventEnd - Time after DOMContentLoaded event completes, 
              domContentLoadedEventStart - Time just before DOMContentLoaded starts and requestStart - Time just before a server request.
              We can see that DOM contents load very fast which suggest that the HTML elements are loaded relatively fast.     
            </p>

        </section>
          
    </main>


    <script>
        function populateTable(userData){
            let body = document.getElementById('userTableBody');
            let row = body.insertRow(0);
            let domStart = row.insertCell(0);
            let domEnd = row.insertCell(1);
            let dom = row.insertCell(2)
            let requestStart = row.insertCell(3);
    

            domStart.innerHTML = userData.dom_Start;
            domEnd.innerHTML = userData.dom_End;
            dom.innerHTML = userData.dom_End - userData.dom_Start;
            requestStart.innerHTML = userData.requestStart;
         
        }

        function getUsers(){
            let url = 'https://bruceandjason135.site/api/performance/';
            fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
            },

            })
            .then(response => response.json())
            .then(user => {
                console.log('Successful user GET!', user);
                for(i=0; i<user.length;i++){
                    populateTable(user[i])
                }
                
            })
            .catch((error) => {
                console.error('Error', error);
                
            })
        }

        getUsers();

        let timeData = {
            values: []
        };

        let fourG_connectionType = {
          values: []
        }
        let threeG_connectionType = {
          values: []
        }
        let twoG_connectionType = {
          values: []
        }
      
        fetch('https://bruceandjason135.site/api/static')
        .then(response => response.json())
        .then(data => {
            let gggg = 0;
            let ggg = 0;
            let gg = 0;
            for (i=0;i<data.length;i++){
              if (data[i].connection_Type == "4g"){
                gggg++;
              }
              if (data[i].connection_Type == "3g"){
                ggg++;
              }
              if (data[i].connection_Type == "2g"){
                gg++;
              }
            }


            console.log(gggg);
            console.log(ggg);
            console.log(gg);
            fourG_connectionType.values.push(gggg);
            threeG_connectionType.values.push(ggg);
            twoG_connectionType.values.push(gg);
        })
        .catch((err) => console.log('Error', err))

        fetch('https://bruceandjason135.site/api/performance')
        .then(response => response.json())
        .then(data => {
            for (i=0;i<data.length;i++){
                timeData.values.push(data[i].total_load_time)
            }
        })
        .catch((err) => console.log('Error', err))

        var pieConfig = {
            "type": "pie",
            "title": {
                "text": "ECT"
            },
            legend: {
                "x":"70%",
                "y":"20%",
                draggable: true,
            },
            "series": [{
                values:   fourG_connectionType.values,
                          backgroundColor: '#031C99 ',
                          text: '4g',
                },
                {
                values:   threeG_connectionType.values,
                          backgroundColor: '#F53B4A ',
                          text: '3g',
                },
                {
                values:   twoG_connectionType.values,
                          backgroundColor: '#EAEF46  ',
                          text: '2g',
                },

            ]
        };

        let myConfig = {
            type: 'bar',
            title: {
                text: 'Total Load Time per User Visit',
                fontSize: "24px",
                adjustLayout: true // Prevents title overlapping graph
            },
            "scale": {
                "size-factor": 0.5
            },
            scaleX: {
                // Set scale label
                label: { 
                    "text": "Visit #",
                    "bold": true,
                    "font-size": "14px",
                },
            },
            scaleY: {
                "max-value": 1100,
                markers: [
                    {
                        type: "line",
                        lineColor: "red",
                        lineWidth: 1,
                        range:[1000],
                        label: {
                            "text": "Critical",
                            backgroundColor: "white",
                            fontColor: "red",
                            fontSize: 14,
                        }
                    }
                ],
                
                label: { 
                    "text": "Total Load Time (ms)",
                    "bold": true,
                    "font-size": "14px",
                },
                
            },
            plotarea: {
                margin: 'dynamic'
            },
            plot: {
                // Animation docs here:
                // https://www.zingchart.com/docs/tutorials/styling/animation#effect
                animation: {
                effect: 'ANIMATION_EXPAND_BOTTOM',
                method: 'ANIMATION_STRONG_EASE_OUT',
                sequence: 'ANIMATION_BY_NODE',
                speed: 275,
                }
            },
            series: [
                {
                values: timeData.values,    
                },
            ]
        };

        setTimeout(function(){
            zingchart.render({
                id: 'loadTime',
                data: myConfig,
                height: 400, // Set to 100% to fully scale to parent container
                width: '80%', // Defau8
            });
            zingchart.render({
                id: 'piechart',
                data: pieConfig,
                height: 400, // Set to 100% to fully scale to parent container
                width: '80%', // Defau8
            });
        }, 810)
    </script>
</body>
</html>